<app-onboarding-stepper [currentStep]="'Clone Settings'"></app-onboarding-stepper>

<div class="clone-settings--section">
    <div class="clone-settings--block">
        <!-- TODO: check loader -->
        <app-loader [phase]="'pre_onboarding'" *ngIf="isLoading" data-cy="configuration-loader"></app-loader>

        <div *ngIf="!isLoading" [formGroup]="cloneSettingsForm">
            <!-- Export Settings -->
            <div>
                <div fxLayoutAlign="start start" class="clone-settings--header-section"
                    data-cy="configuration-contents">
                    <div class="clone-settings--header-icon">
                        <img src="assets/images/svgs/general/setting.svg">
                    </div>
                    <div>
                        <h3>Export Settings</h3>
                        <h5 class="clone-settings--header-caption sub-text-color">In this section, you can configure how
                            and when expenses from Fyle need to be exported to Xero</h5>
                    </div>
                </div>

                <div class="clone-settings--configuration-section">
                    <div fxLayout="row">
                        <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                            <p>Reimbursable Expense</p>
                            <img class="clone-settings--info-icon" src="assets/images/svgs/general/info-disabled.svg">
                        </div>

                        <div class="clone-settings--export-type">
                            <app-toggle [isCloneSettings]="true" [form]="cloneSettingsForm"
                                [formControllerName]="'reimbursableExpense'"></app-toggle>
                        </div>
                    </div>
                </div>

                <div *ngIf="cloneSettingsForm.value.reimbursableExpense">
                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/employee-disabled.svg">
                                <p class="clone-settings--sub-options-text">Employee Mapping</p>
                            </div>

                            <div>
                                <app-select [form]="cloneSettingsForm" [options]="autoMapEmployeeTypes"
                                    [isFieldMandatory]="false" [placeholder]="'Select auto map employee type'"
                                    [formControllerName]="'autoMapEmployees'"
                                    [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/document-disabled.svg">
                                <p class="clone-settings--sub-options-text">Mode of Export</p>
                            </div>

                            <div class="clone-settings--sub-options-text clone-settings--export-type">
                                Purchase Bill
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/calendar-disabled.svg">
                                <p class="clone-settings--sub-options-text">Date of export</p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-select [form]="cloneSettingsForm"
                                    [options]="reimbursableExpenseGroupingDateOptions" [isFieldMandatory]="true"
                                    [mandatoryErrorListName]="'Purchase Bill Date'"
                                    [placeholder]="'Select the Purchase Bill date'"
                                    [formControllerName]="'reimbursableExportDate'"
                                    [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/calendar-disabled.svg">
                                <p class="clone-settings--sub-options-text">State of export</p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-select [form]="cloneSettingsForm" [options]="reimbursableExpenseStateOptions"
                                    [isFieldMandatory]="true" [mandatoryErrorListName]="'Purchase Bill Date'"
                                    [placeholder]="'Select the Expense State'"
                                    [formControllerName]="'reimbursableExpenseState'"
                                    [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="clone-settings--configuration-section">
                    <div fxLayout="row">
                        <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                            <p>Corporate Card Expense</p>
                            <img class="clone-settings--info-icon" src="assets/images/svgs/general/info-disabled.svg">
                        </div>

                        <div class="clone-settings--export-type">
                            <app-toggle [isCloneSettings]="true" [form]="cloneSettingsForm"
                                [formControllerName]="'creditCardExpense'"></app-toggle>
                        </div>
                    </div>
                </div>

                <div *ngIf="cloneSettingsForm.value.creditCardExpense">
                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/document-disabled.svg">
                                <p class="clone-settings--sub-options-text">Mode of Export</p>
                            </div>

                            <div class="clone-settings--sub-options-text clone-settings--export-type">
                                Bank Transactions
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/calendar-disabled.svg">
                                <p class="clone-settings--sub-options-text">
                                    To which Bank account should the transaction be posted?
                                    <app-mandatory-field></app-mandatory-field>
                                </p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-select [form]="cloneSettingsForm" [xeroAttributes]="bankAccounts"
                                    [isFieldMandatory]="true" [mandatoryErrorListName]="'Bank account'"
                                    [placeholder]="'Select bank account'" [formControllerName]="'bankAccount'"
                                    [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>


                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/calendar-disabled.svg">
                                <p class="clone-settings--sub-options-text">State of export</p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-select [form]="cloneSettingsForm" [options]="cccExpenseStateOptions"
                                    [isFieldMandatory]="true" [mandatoryErrorListName]="'CCC Expense State'"
                                    [placeholder]="'Select the Expense State'" [formControllerName]="'cccExpenseState'"
                                    [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Import Settings -->
            <div>
                <div fxLayoutAlign="start start" class="clone-settings--header-section"
                    data-cy="configuration-contents">
                    <div class="clone-settings--header-icon">
                        <img src="assets/images/svgs/general/setting.svg">
                    </div>
                    <div>
                        <h3>Import Settings</h3>
                        <h5 class="clone-settings--header-caption sub-text-color">In this section, you can configure how
                            the dimensions you import from Xero should be mapped in Fyle</h5>
                    </div>
                </div>

                <div class="clone-settings--field-header-section">
                    <div fxLayoutAlign="start center" class="clone-settings--field-header">
                        <div class="clone-settings--xero-header">
                            Xero Field
                        </div>
                        <div>
                            Fyle Field
                        </div>
                    </div>
                </div>

                <div>
                    <div fxLayoutAlign="space-between center" class="clone-settings--coa-import-section"
                        (mouseenter)="hoveredIndex.categoryImport= 1" (mouseleave)="hoveredIndex.categoryImport= -1">
                        <div fxLayoutAlign="start center">
                            <div fxLayoutAlign="start center" class="clone-settings--xero-field">
                                <p class="clone-settings--xero-field-text">
                                    Chart of Accounts
                                </p>
                            </div>

                            <img src="assets/images/svgs/general/connect-arrow.svg">

                            <div fxLayoutAlign="start center" class="clone-settings--xero-field">
                                <p class="clone-settings--xero-field-text">
                                    Category
                                </p>
                            </div>

                            <div class="clone-settings--coa-list clone-settings--cta-text pointer"
                                [matMenuTriggerFor]="menu">
                                View Accounts
                                <img class="clone-settings--coa-list-icon"
                                    src="assets/images/svgs/actions/arrow-mark-down-pink.svg">
                            </div>
                            <mat-menu formArrayName="chartOfAccountTypes" #menu="matMenu">
                                <div *ngFor="let chartOfAccountType of chartOfAccountTypes.controls; let i = index"
                                    [formGroupName]="i" mat-menu-item (click)="$event.stopPropagation()">
                                    <mat-checkbox [checked]="chartOfAccountType.value.enabled"
                                        [disabled]="chartOfAccountType.value.name === 'Expense'">
                                        {{ chartOfAccountType.value.name }}
                                    </mat-checkbox>
                                </div>
                            </mat-menu>
                        </div>
                        <div *ngIf="hoveredIndex.categoryImport === 1">
                            <img matTooltip="Delete" matTooltipPosition="left" matTooltipClass="left" width="18px"
                                height="20px" src="assets/images/svgs/actions/delete.svg"
                                class="clone-settings--delete-icon pointer">
                        </div>
                    </div>

                    <div formArrayName="expenseFields">
                        <div *ngFor="let expenseField of expenseFields.controls; let i = index" [formGroupName]="i"
                            fxLayoutAlign="space-between center" class="clone-settings--coa-import-section"
                            (mouseenter)="hoveredIndex.expenseFieldImport= i"
                            (mouseleave)="hoveredIndex.expenseFieldImport= -1">
                            <div>
                                <div fxLayoutAlign="space-between center">
                                    <div fxLayoutAlign="start center" class="clone-settings--xero-field">
                                        <p class="clone-settings--xero-field-text">
                                            {{ expenseField.value.destination_field | titlecase }}
                                        </p>
                                    </div>

                                    <img src="assets/images/svgs/general/connect-arrow.svg">

                                    <mat-form-field floatLabel="always" appearance="outline"
                                        class="import-settings--fyle-field">
                                        <mat-select placeholder="Select a field from Fyle"
                                            formControlName="source_field" data-cy="select-field">
                                            <mat-option *ngFor="let fyleExpenseField of fyleExpenseFields"
                                                [value]="fyleExpenseField" data-cy="select-option">
                                                {{ fyleExpenseField.split('_').join(' ') | titlecase }}
                                                <img *ngIf="fyleExpenseField === expenseField.value.source_field"
                                                    src="assets/images/svgs/general/tick-pink.svg"
                                                    class="selected-value-check-mark">
                                            </mat-option>
                                        </mat-select>
                                        <div class="mat-select-arrow-closed"></div>
                                    </mat-form-field>

                                    <p *ngIf="!expenseField.value.source_field"
                                        class="clone-settings--coa-list sub-text-color">or</p>
                                    <p *ngIf="!expenseField.value.source_field"
                                        class="clone-settings--coa-list pointer clone-settings--cta-text"
                                        (click)="createExpenseField(expenseField.value.destination_field)">
                                        Create a new field in Fyle
                                    </p>
                                </div>
                            </div>

                            <div *ngIf="i === hoveredIndex.expenseFieldImport">
                                <img matTooltip="Delete" matTooltipPosition="left" matTooltipClass="left" width="18px"
                                    height="20px" src="assets/images/svgs/actions/delete.svg"
                                    class="clone-settings--delete-icon pointer">
                            </div>
                        </div>
                    </div>

                    <div fxLayoutAlign="space-between center" class="clone-settings--coa-import-section"
                        (mouseenter)="hoveredIndex.taxImport= 1" (mouseleave)="hoveredIndex.taxImport= -1">
                        <div fxLayoutAlign="start center">
                            <div fxLayoutAlign="start center" class="clone-settings--xero-field">
                                <p class="clone-settings--xero-field-text">
                                    Tax Code
                                </p>
                            </div>

                            <img src="assets/images/svgs/general/connect-arrow.svg">

                            <div fxLayoutAlign="start center" class="clone-settings--xero-field clone-settings--tax-group-field">
                                <p class="clone-settings--xero-field-text">
                                    Tax Group
                                </p>
                            </div>

                            <app-select [form]="cloneSettingsForm" [xeroAttributes]="taxCodes" [isFieldMandatory]="true"
                                [mandatoryErrorListName]="'Tax group'" [placeholder]="'Select Default Tax Code'"
                                [formControllerName]="'defaultTaxCode'" [phase]="ProgressPhase.ONBOARDING"
                                [isCloneSettingField]="true"></app-select>
                        </div>
                        <div *ngIf="hoveredIndex.taxImport === 1">
                            <img matTooltip="Delete" matTooltipPosition="left" matTooltipClass="left" width="18px"
                                height="20px" src="assets/images/svgs/actions/delete.svg"
                                class="clone-settings--delete-icon pointer">
                        </div>
                    </div>
                </div>
            </div>


            <!-- Advanced Settings -->
            <div class="clone-settings--header-advanced-setting">
                <div fxLayoutAlign="start start" class="clone-settings--header-section"
                    data-cy="configuration-contents">
                    <div class="clone-settings--header-icon">
                        <img src="assets/images/svgs/general/setting.svg">
                    </div>
                    <div>
                        <h3>Advanced Settings</h3>
                        <h5 class="clone-settings--header-caption sub-text-color">
                            This section contains settings to automate and customize your expense exports
                        </h5>
                    </div>
                </div>

                <div>
                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/sync-disabled.svg">
                                <p class="clone-settings--sub-options-text">Auto - Sync payment between Fyle and Xero</p>
                            </div>

                            <div>
                                <app-select [form]="cloneSettingsForm" [options]="paymentSyncOptions"
                                    [isFieldMandatory]="false" [placeholder]="'Select how payments should be synced for reimbursable expenses'"
                                    [formControllerName]="'paymentSync'"
                                    [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="cloneSettingsForm.value.paymentSync && cloneSettingsForm.value.paymentSync === 'fyle_to_xero'" class="clone-settings--configuration-payment-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section clone-settings--configuration-payment-field" fxLayout="row" fxLayoutAlign="start center">
                                <p class="clone-settings--sub-options-text">
                                    To which Payment account should the payment entries be posted?
                                    <app-mandatory-field></app-mandatory-field>
                                </p>
                            </div>

                            <div>
                                <app-select [form]="cloneSettingsForm" [xeroAttributes]="bankAccounts"
                                [isFieldMandatory]="true" [mandatoryErrorListName]="'payment account'"
                                [placeholder]="'Select a Payment Account'" [formControllerName]="'billPaymentAccount'"
                                [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/calendar-disabled.svg">
                                <p class="clone-settings--sub-options-text">Schedule automatic export</p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-toggle [isCloneSettings]="true" [form]="cloneSettingsForm"
                                [formControllerName]="'exportSchedule'"></app-toggle>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="cloneSettingsForm.value.exportSchedule" class="clone-settings--configuration-payment-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section clone-settings--configuration-payment-field" fxLayout="row" fxLayoutAlign="start center">
                                <p class="clone-settings--sub-options-text">
                                    Set the frequency of export
                                    <app-mandatory-field></app-mandatory-field>
                                </p>
                            </div>

                            <div>
                                <app-select [form]="cloneSettingsForm" [options]="frequencyIntervals"
                                    [isFieldMandatory]="true" [mandatoryErrorListName]="'frequency'" [placeholder]="'Select Frequency'"
                                    [formControllerName]="'exportScheduleFrequency'"
                                    [phase]="ProgressPhase.ONBOARDING"></app-select>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="cloneSettingsForm.value.exportSchedule" class="clone-settings--configuration-payment-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section clone-settings--configuration-payment-field" fxLayout="row" fxLayoutAlign="start center">
                                <p class="clone-settings--sub-options-text clone-settings--additional-email-text">
                                    Select an email address to notify upon export failure
                                    <app-mandatory-field></app-mandatory-field>
                                </p>
                            </div>

                            <div>
                                <app-email-multi-select
                                    [form]="cloneSettingsForm"
                                    [options]="adminEmails"
                                    [isFieldMandatory]="false"
                                    [placeholder]="'Select Email Address'"
                                    [formControllerName]="'emails'"
                                ></app-email-multi-select>
                                <div fxLayout="row" class="clone-settings--add-email-text pointer" fxLayoutAlign="end center"
                                    (click)="openAddemailDialog()">
                                    <span class="clone-settings--span-or">or</span>
                                    <img class="clone-settings--add-btn" src="assets/images/svgs/actions/add.svg">
                                    <span class="clone-settings--span-or">Add new email address</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/calendar-disabled.svg">
                                <p class="clone-settings--sub-options-text">Post entries in the next open accounting period</p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-toggle [isCloneSettings]="true" [form]="cloneSettingsForm"
                                [formControllerName]="'changeAccountingPeriod'"></app-toggle>
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/document-disabled.svg">
                                <p class="clone-settings--sub-options-text">Auto-Create Contacts</p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-toggle [isCloneSettings]="true" [form]="cloneSettingsForm"
                                [formControllerName]="'autoCreateVendors'"></app-toggle>
                            </div>
                        </div>
                    </div>

                    <div class="clone-settings--configuration-section">
                        <div fxLayout="row">
                            <div class="clone-settings--field-section" fxLayout="row" fxLayoutAlign="start center">
                                <img class="clone-settings--sub-options-icon"
                                    src="assets/images/svgs/general/document-disabled.svg">
                                <p class="clone-settings--sub-options-text">Auto-Create Merchants as Contacts</p>
                            </div>

                            <div class="clone-settings--sub-options-text">
                                <app-toggle [isCloneSettings]="true" [form]="cloneSettingsForm"
                                [formControllerName]="'autoCreateMerchantDestinationEntity'"></app-toggle>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="clone-settings--footer-section">
                <div class="clone-settings--footer-inner-section">
                    <div fxLayoutAlign="space-between center">
                        <div fxLayoutAlign="start center">
                            <div>1</div>
                            <div>2</div>
                        </div>
                        <div>2</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<app-onboarding-footer *ngIf="!isLoading"></app-onboarding-footer>
